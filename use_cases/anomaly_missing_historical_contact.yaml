name: missing historical contact
purpose: this use case aims to identify employees who recently have had contact with a patient but have not had any prior contact with the same patient in the last 6 months. 
prerequisites: 
- indexes: 
          anomaly_collection (explanation: an index where identified anomalies are stored as events)
- lookups: 
          baseline_historical_contact (explanation: a lookup file that stores information about when employees and patients last have had contact)
- macros: 
          pda_indexes (explanation: references the indexes where patient privacy act associated logs and events are stored)
          pda_sourcetypes (explanation: references the sourcetypes assigned to patient privacy act associated logs and events)
          pda_sources (explanation: references the sources assigned to patient privacy act associated logs and events)
- fields: 
          staff_ID (explanation: a unique identifier for the employee)
          patient_ID (explanation: a unique identifier for the patient)
- searches: 
          search 1
          search 2
          search 3
how_to_implement (note: everything is case sensitive, and the steps should be done in a sequential order):
          1. create an index called 'anomaly_collection'.
          2. create a KVstore lookup called 'baseline_historical_contact', which should include the fields 'staff_ID', 'patient_ID', and 'last_contact'.
          3. create the field extractions and field aliases for 'staff_ID' and 'patient_ID'. 
          4. create the macros 'pda_indexes', 'pda_sourcetypes', and 'pda_sources'. Have them refer to the indexes, sourcetypes and sources that are used by the logs and events that fall under the Patient Data Act - this ensures that when the macros are referenced in a search, Splunk will retreive the right data. 
          5. create 'search 1', followed by 'search 2', followed by 'search 3'.
search 1: 
- description: establishes a baseline of historical contact for the past 6 months.
- search: 
          `pda_indexes` `pda_sourcetypes` `pda_sources` earliest=-6mon
          | fields _time, staff_ID, patient_ID
          | stats latest(_time) as last_contact count by staff_ID, patient_ID
          | table staff_ID, patient_ID, last_contact
          | outputlookup baseline_historical_contact
- time range picker: the time range for search 1 is explicitly defined within the search using the earliest option (earliest=-6mon). By default, the search processes data from current time to 6 month ago (with the possiblity to adjust to specific needs/requirements).
- cron schedule: N/A (run only once in the search bar).
search 2: 
- description: incrementally updates the contact history daily.
- search:
          | inputlookup baseline_historical_contact
          | append [
                    `pda_indexes` `pda_sourcetypes` `pda_sources` earliest=-1d@d latest=@d
                    | fields _time, staff_ID, patient_ID
                    | stats latest(_time) as last_contact count by staff_ID, patient_ID
                    | table staff_ID, patient_ID, last_contact
                   ]
          | stats max(last_contact) as last_contact by staff_ID, patient_ID
          | table staff_ID, patient_ID, last_contact
          | outputlookup baseline_historical_contact
- time range picker: the time range for search 2 is explicitly defined in the search using the earliest and latest options (earliest=-1d@d and latest=@d). By default, the search processes data from the entire previous day (midnight to midnight).
- cron schedule: 0 0 * * * (scheduled to run every day of the week at midnight).
search 3:
- description: identifies employees who have had contact with a patient within the past 10-minute window (accounting for a 2-minute latency) but have not had any prior contact with the same patient in the last 6 months. For every single match, an anomaly is triggered and stored in the anomaly index for further correlation and analytics.
- search:
          `pda_indexes` `pda_sourcetypes` `pda_sources` earliest=-12min@min latest=-2min@min
          | fields _time, staff_ID, patient_ID
          | stats count by staff_ID, patient_ID
          | lookup baseline_historical_contact staff_ID patient_ID
          | eval time_since_last_contact = now() - last_contact
          | eval anomaly = if(isnull(last_contact) OR time_since_last_contact >= 14515200 , "1", "0")
          | where anomaly = "1"
          | eval title = "Historical contact deviation"
          | eval description = ""
          | addinfo
          | eval drilldown_search="`pda_indexes` `pda_sourcetypes` `pda_sources` Staff_ID=" . Staff_ID . " Patient_ID=" . Patient_ID . " earliest=" . info_min_time . " latest=" . info_max_time
          | eval risk_score = "20" ```this should be a value ranging from 0 and 100 - please adjust so it aligns with the perceived risk of this type of anomaly```
          | fields title, description, drilldown_search, risk_score, staff_ID, patient_ID
          | collect index=anomaly_collection addinfo=false
- time range picker: the time range for search 3 is explicitly defined within the search using the earliest and latest options (earliest=-12min@min and latest=-2min@min). By default, the search processes data from 12 minutes ago up to 2 minutes ago (with the possiblity to adjust to specific needs/requirements), ensuring a consistent 10-minute window that accounts for potential data latency.
- cron schedule: */10 * * * * (scheduled to run every 10th minute of every hour, 24/7, across all days of the week).

